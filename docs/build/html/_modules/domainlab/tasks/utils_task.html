<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#2196f3">
  <script src="../../../_static/javascripts/modernizr.js"></script>
  
  
    <link rel="apple-touch-icon" href="../../../_static/images/apple-icon-152x152.png"/>
  
  
    <title>domainlab.tasks.utils_task &#8212; domainlab  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
    <link rel="stylesheet" type="text/css" href="../../../_static/material.css?v=79c92029" />
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  
    <link rel="apple-touch-icon" href="../../../_static/images/apple-icon-152x152.png"/>
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=teal data-md-color-accent=cyan>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#_modules/domainlab/tasks/utils_task" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../index.html" title="domainlab  documentation"
           class="md-header-nav__button md-logo">
          
            <i class="md-icon">school</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">DomainLab</span>
          <span class="md-header-nav__topic"> domainlab.tasks.utils_task </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder=""Search""
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/marrlab/DomainLab" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    DomainLab
  </div>
</a>
          </div>
        </div>
      
      
    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
            
            <li class="md-tabs__item"><a href="../../../readme_link.html" class="md-tabs__link">Introduction</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_tasks.html" class="md-tabs__link">Task Specification</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_custom_nn.html" class="md-tabs__link">Custom Neural Network</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_MNIST_classification.html" class="md-tabs__link">Examples with MNIST</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_examples.html" class="md-tabs__link">Examples by algorithm</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_benchmark.html" class="md-tabs__link">Benchmarks</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_output.html" class="md-tabs__link">Output Structure</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_extend_contribute.html" class="md-tabs__link">Extend and Contribute</a></li>
          <li class="md-tabs__item"><a href="../../index.html" class="md-tabs__link">Module code</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../index.html" title="domainlab documentation" class="md-nav__button md-logo">
      
        <i class="md-icon">school</i>
      
    </a>
    <a href="../../../index.html"
       title="domainlab documentation">DomainLab</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/marrlab/DomainLab" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    DomainLab
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Contents:</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../modules.html" class="md-nav__link">domainlab</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../docHDUVA.html" class="md-nav__link">Model HDUVA</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../doc_dann.html" class="md-nav__link">Model DANN:</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../docJiGen.html" class="md-nav__link">Model JiGen</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../doc_diva.html" class="md-nav__link">Model DIVA: Domain Invariant Variational Autoencoders</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../docMatchDG.html" class="md-nav__link">Trainer MatchDG: Domain Generalization using Causal Matching</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../docDIAL.html" class="md-nav__link">Trainer DIAL: Domain Invariant Adversarial Learning</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
  <ul class="md-nav__list" data-md-scrollfix="">
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <h1 id="modules-domainlab-tasks-utils-task--page-root">Source code for domainlab.tasks.utils_task</h1><div class="highlight"><pre>
<span></span>"""
Task wraps around datasets, this file provide utilities
"""
import os
from pathlib import Path

import numpy
import torch
import torchvision
from torch.utils.data import Dataset

from domainlab.utils.utils_class import store_args


<div class="viewcode-block" id="ImSize">
<a class="viewcode-back" href="../../../domainlab.tasks.html#domainlab.tasks.utils_task.ImSize">[docs]</a>
class ImSize():
    """ImSize."""

    @store_args
    def __init__(self, i_c, i_h, i_w):
        """
        store channel, height, width
        """
    @property
    def c(self):
        """image channel"""
        return self.i_c

    @property
    def h(self):
        """image height"""
        return self.i_h

    @property
    def w(self):
        """image width"""
        return self.i_w</div>



<div class="viewcode-block" id="mk_onehot">
<a class="viewcode-back" href="../../../domainlab.tasks.html#domainlab.tasks.utils_task.mk_onehot">[docs]</a>
def mk_onehot(dim, ind):
    """
    :param dim: dimension of representation vector
    :param ind: index
    """
    eye = torch.eye(dim)
    vec = eye[ind]
    return vec</div>



<div class="viewcode-block" id="mk_loader">
<a class="viewcode-back" href="../../../domainlab.tasks.html#domainlab.tasks.utils_task.mk_loader">[docs]</a>
def mk_loader(dset, bsize,
              drop_last=True,
              shuffle=True,
              num_workers=int(0)):
    """
    :param bs: batch size
    """
    if len(dset) &lt; bsize:
        bsize = len(dset)
    loader = torch.utils.data.DataLoader(
        dataset=dset,
        batch_size=bsize,
        shuffle=shuffle,
        # @FIXME: shuffle must be true so the last incomplete batch get used in another epoch?
        num_workers=num_workers,   # @FIXME: num_workers=int(0) can be slow?
        drop_last=drop_last)
    return loader</div>



<div class="viewcode-block" id="DsetDomainVecDecorator">
<a class="viewcode-back" href="../../../domainlab.tasks.html#domainlab.tasks.utils_task.DsetDomainVecDecorator">[docs]</a>
class DsetDomainVecDecorator(Dataset):
    """
    decorate a pytorch dataset with a fixed vector representation of domain
    """
    def __init__(self, dset, vec_domain, na_domain):
        """
        :param dset: x, y
        :param vec_domain: vector representation of domain
        :param na_domain: string description of domain
        """
        self.dset = dset
        self.vec_domain = vec_domain
        self.na_domain = na_domain

    @property
    def targets(self):
        """
        return a list of all targets so class sample count is straight forward
        """
        return self.dset.targets

    def __getitem__(self, idx):
        """
        :param idx:
        """
        tensor, vec_class, *other_vars = self.dset.__getitem__(idx)
        if other_vars:
            return (tensor, vec_class, self.vec_domain, *other_vars)
        return tensor, vec_class, self.vec_domain

    def __len__(self):
        """__len__."""
        return self.dset.__len__()</div>



<div class="viewcode-block" id="DsetDomainVecDecoratorImgPath">
<a class="viewcode-back" href="../../../domainlab.tasks.html#domainlab.tasks.utils_task.DsetDomainVecDecoratorImgPath">[docs]</a>
class DsetDomainVecDecoratorImgPath(DsetDomainVecDecorator):
    """
    Except returning x, y, d, additionally, the path of x is
    returned currently not in use since it is mostly important
    to print predictions together with path  for the test domain
    """
    def __getitem__(self, idx):
        """
        :param idx:
        """
        tensor, vec_class, path = self.dset.__getitem__(idx)
        return tensor, vec_class, self.vec_domain, path</div>



<div class="viewcode-block" id="DsetClassVecDecorator">
<a class="viewcode-back" href="../../../domainlab.tasks.html#domainlab.tasks.utils_task.DsetClassVecDecorator">[docs]</a>
class DsetClassVecDecorator(Dataset):
    """
    decorate a pytorch dataset with a new class name
    """
    def __init__(self, dset, dict_folder_name2class_global, list_str_y):
        """
        :param dset: x, y, *d
        :param dict_folder2class: dictionary that maps
                class folder of domain to glbal class
        """
        self.dset = dset
        self.class2idx = {k:v for (k,v) in self.dset.class_to_idx.items() \
                          if k in self.dset.list_class_dir}
        assert self.class2idx
        self.dict_folder_name2class_global = dict_folder_name2class_global
        self.list_str_y = list_str_y
        # inverst key:value to value:key for backward map
        self.dict_old_idx2old_class = dict((v, k) for k, v in self.class2idx.items())
        dict_class_na_local2vec_new = dict(
            (k, self.fun_class_local_na2vec_new(k)) for k, v in self.class2idx.items())
        self.dict_class_na_local2vec_new = dict_class_na_local2vec_new

    @property
    def targets(self):
        """
        return a list of all targets so class sample count is straight forward
        """
        return self.dset.targets

<div class="viewcode-block" id="DsetClassVecDecorator.fun_class_local_na2vec_new">
<a class="viewcode-back" href="../../../domainlab.tasks.html#domainlab.tasks.utils_task.DsetClassVecDecorator.fun_class_local_na2vec_new">[docs]</a>
    def fun_class_local_na2vec_new(self, k):
        """
        local class name within one domain, to one-hot
        vector of new representation
        """
        ind = self.list_str_y.index(self.dict_folder_name2class_global[k])
        return mk_onehot(len(self.list_str_y), ind)</div>


    def __getitem__(self, idx):
        """
        :param idx:
        """
        tensor, vec_class, *other_vars = self.dset.__getitem__(idx)
        vec_class = vec_class.numpy()
        ind_old = numpy.argmax(vec_class)
        class_local = self.dict_old_idx2old_class[ind_old]
        vec_class_new = self.dict_class_na_local2vec_new[class_local]
        return tensor, vec_class_new, *other_vars

    def __len__(self):
        """__len__."""
        return self.dset.__len__()</div>



<div class="viewcode-block" id="DsetClassVecDecoratorImgPath">
<a class="viewcode-back" href="../../../domainlab.tasks.html#domainlab.tasks.utils_task.DsetClassVecDecoratorImgPath">[docs]</a>
class DsetClassVecDecoratorImgPath(DsetClassVecDecorator):
    def __getitem__(self, idx):
        """
        :param idx:
        This function is mainly
        """
        tensor, vec_class_new, path = super().__getitem__(idx)
        return tensor, vec_class_new, path[0]</div>



<div class="viewcode-block" id="LoaderDomainLabel">
<a class="viewcode-back" href="../../../domainlab.tasks.html#domainlab.tasks.utils_task.LoaderDomainLabel">[docs]</a>
class LoaderDomainLabel():
    """
    wraps a dataset with domain label and into a loader
    """
    def __init__(self, batch_size, dim_d):
        """__init__.

        :param batch_size:
        :param dim_d:
        """
        self.batch_size = batch_size
        self.dim_d = dim_d

    def __call__(self, dset, d_ind, na_domain):
        """
        wrap_dataset2loader_with_domain_label.
        :param dataset:
        :param batch_size:
        :param d_dim:
        :param d_ind:
        """
        d_eye = torch.eye(self.dim_d)
        d_label = d_eye[d_ind]
        dset = DsetDomainVecDecorator(dset, d_label, na_domain)
        loader = mk_loader(dset, self.batch_size)
        return loader</div>



<div class="viewcode-block" id="tensor1hot2ind">
<a class="viewcode-back" href="../../../domainlab.tasks.html#domainlab.tasks.utils_task.tensor1hot2ind">[docs]</a>
def tensor1hot2ind(tensor_label):
    """tensor1hot2ind.

    :param tensor_label:
    """
    _, label_ind = torch.max(tensor_label, dim=1)
    npa_label_ind = label_ind.numpy()
    return npa_label_ind</div>


# @FIXME: this function couples strongly with the task,
# should be a class method of task
<div class="viewcode-block" id="img_loader2dir">
<a class="viewcode-back" href="../../../domainlab.tasks.html#domainlab.tasks.utils_task.img_loader2dir">[docs]</a>
def img_loader2dir(loader,
                   folder,
                   test=False,
                   list_domain_na=None,
                   list_class_na=None,
                   batches=5):
    """
    save images from loader to directory so speculate if loader is correct
    :param loader: pytorch data loader
    :param folder: folder to save images
    :param test: if true, the loader is assumend to be a test loader; if false (default) it is assumed to be a train loader
    :param list_domain_na: optional list of domain names
    :param list_class_na: optional list of class names
    :param batches: number of batches to save
    """
    Path(os.path.normpath(folder)).mkdir(parents=True, exist_ok=True)
    l_iter = iter(loader)
    counter = 0
    batches = min(batches, len(l_iter))
    for _ in range(batches):
        img, vec_y, *other_vars = next(l_iter)
        class_label_ind_batch = tensor1hot2ind(vec_y)

        # get domain label
        # Note 1: test loaders don't return domain labels (see NodeTaskDictClassif.init_business)
        # Note 2: for train loaders domain label will be the 0th element of other_vars (see DsetDomainVecDecorator class above)
        has_domain_label_ind = False
        if not test:
            if other_vars:
                domain_label_ind_batch = tensor1hot2ind(other_vars[0])
                has_domain_label_ind = True

        for b_ind in range(img.shape[0]):
            class_label_ind = class_label_ind_batch[b_ind]
            class_label_scalar = class_label_ind.item()

            if list_class_na is None:
                str_class_label = "class_"+str(class_label_scalar)
            else:
                # @FIXME: where is the correspndance between
                # class ind_label and class str_label?
                str_class_label = list_class_na[class_label_scalar]
            str_domain_label = "unknown"
            if has_domain_label_ind:
                domain_label_ind = domain_label_ind_batch[b_ind]
                if list_domain_na is None:
                    str_domain_label = str(domain_label_ind)
                else:
                    # @FIXME: the correspondance between
                    # domain ind_label and domain str_label is missing
                    str_domain_label = list_domain_na[domain_label_ind]
            arr = img[b_ind]
            img_vision = torchvision.transforms.ToPILImage()(arr)
            f_n = "_".join(
                ["class",
                 str_class_label,
                 "domain",
                 str_domain_label,
                 "n",
                 str(counter)])
            counter += 1
            path = os.path.join(folder, f_n + ".png")
            img_vision.save(path)</div>

</pre></div>

          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2021-2023, Marr Lab..
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>