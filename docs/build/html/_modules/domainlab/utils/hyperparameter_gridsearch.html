
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#2196f3">
  <script src="../../../_static/javascripts/modernizr.js"></script>
  
  
    <link rel="apple-touch-icon" href="../../../_static/images/apple-icon-152x152.png"/>
  
  
    <title>domainlab.utils.hyperparameter_gridsearch &#8212; domainlab  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/material.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  
    <link rel="apple-touch-icon" href="../../../_static/images/apple-icon-152x152.png"/>
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=teal data-md-color-accent=cyan>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#_modules/domainlab/utils/hyperparameter_gridsearch" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../index.html" title="domainlab  documentation"
           class="md-header-nav__button md-logo">
          
            <i class="md-icon">school</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">DomainLab</span>
          <span class="md-header-nav__topic"> domainlab.utils.hyperparameter_gridsearch </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/marrlab/DomainLab" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    DomainLab
  </div>
</a>
          </div>
        </div>
      
      
    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
            
            <li class="md-tabs__item"><a href="../../../readme_link.html" class="md-tabs__link">Introduction</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_tasks.html" class="md-tabs__link">Task Specification</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_custom_nn.html" class="md-tabs__link">Specify neural network in commandline</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_MNIST_classification.html" class="md-tabs__link">Examples with MNIST</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_examples.html" class="md-tabs__link">More commandline examples</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_benchmark.html" class="md-tabs__link">Benchmarks tutorial</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_output.html" class="md-tabs__link">Output Structure</a></li>
            
            <li class="md-tabs__item"><a href="../../../doc_extend_contribute.html" class="md-tabs__link">Developers note</a></li>
          <li class="md-tabs__item"><a href="../../index.html" class="md-tabs__link">Module code</a></li>
          <li class="md-tabs__item"><a href="../../domainlab.html" class="md-tabs__link">domainlab</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../index.html" title="domainlab documentation" class="md-nav__button md-logo">
      
        <i class="md-icon">school</i>
      
    </a>
    <a href="../../../index.html"
       title="domainlab documentation">DomainLab</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/marrlab/DomainLab" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    DomainLab
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Contents:</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../modules.html" class="md-nav__link">domainlab</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../docHDUVA.html" class="md-nav__link">Model HDUVA</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../doc_dann.html" class="md-nav__link">Model DANN</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../docJiGen.html" class="md-nav__link">Model JiGen</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../doc_diva.html" class="md-nav__link">Model DIVA</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../docMatchDG.html" class="md-nav__link">Trainer MatchDG</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../docDIAL.html" class="md-nav__link">Trainer DIAL</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../docFishr.html" class="md-nav__link">Trainer Fishr</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../doc_mldg.html" class="md-nav__link">Trainer MLDG</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
  <ul class="md-nav__list" data-md-scrollfix="">
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <h1 id="modules-domainlab-utils-hyperparameter-gridsearch--page-root">Source code for domainlab.utils.hyperparameter_gridsearch</h1><div class="highlight"><pre>
<span></span>"""
gridsearch for the hyperparameter space

def add_next_param_from_list is an recursive function to make cartesian product along all the scalar hyper-parameters, this resursive function is used
in def grid_task

"""
import copy
import json
import os
import warnings

import numpy as np
import pandas as pd

import domainlab.utils.hyperparameter_sampling as sampling
from domainlab import g_name_num_shared_param_samples_rand_search
from domainlab.utils.get_git_tag import get_git_tag
from domainlab.utils.logger import Logger

G_MODEL_NA = "model"
G_METHOD_NA = "method"


<div class="viewcode-block" id="round_to_discreate_grid_uniform"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.round_to_discreate_grid_uniform">[docs]</a>def round_to_discreate_grid_uniform(grid, param_config):
    """
    round the values of the grid to the grid spacing specified in the config
    for uniform and loguniform grids
    """
    if float(param_config["step"]) == 0:
        return grid
    mini = float(param_config["min"])
    maxi = float(param_config["max"])
    if maxi - mini &lt; float(param_config["step"]):
        raise RuntimeError(
            "distance between max and min to small for defined step size"
        )

    discreate_gird = np.arange(
        mini, maxi + float(param_config["step"]), step=float(param_config["step"])
    )
    for num, elem in enumerate(list(grid)):
        # search for the closest allowed grid point to the scalar elem
        grid[num] = discreate_gird[(np.abs(discreate_gird - elem)).argmin()]
    grid_unique = np.unique(grid)
    grid_out = grid_unique
    return grid_out</div>


<div class="viewcode-block" id="round_to_discreate_grid_normal"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.round_to_discreate_grid_normal">[docs]</a>def round_to_discreate_grid_normal(grid, param_config):
    """
    round the values of the grid to the grid spacing specified in the config
    for normal and lognormal grids
    """
    if float(param_config["step"]) == 0:
        return grid
    # for normal and lognormal no min and max is provided
    # in this case the grid is constructed around the mean
    neg_steps = np.ceil(
        (float(param_config["mean"]) - np.min(grid)) / float(param_config["step"])
    )
    pos_steps = np.ceil(
        (np.max(grid) - float(param_config["mean"])) / float(param_config["step"])
    )
    mini = float(param_config["mean"]) - float(param_config["step"]) * neg_steps
    maxi = float(param_config["mean"]) + float(param_config["step"]) * pos_steps

    discreate_gird = np.arange(mini, maxi, step=float(param_config["step"]))
    for num, elem in enumerate(list(grid)):
        grid[num] = discreate_gird[(np.abs(discreate_gird - elem)).argmin()]
    return np.unique(grid)</div>


<div class="viewcode-block" id="uniform_grid"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.uniform_grid">[docs]</a>def uniform_grid(param_config):
    """
    get a uniform distributed grid given the specifications in the param_config
    param_config: config which needs to contain 'num', 'max', 'min', 'step'
    """
    num = int(param_config["num"])
    maxi = float(param_config["max"])
    mini = float(param_config["min"])
    step = (maxi - mini) / num
    # linspace does include the end of the interval and include the beginning
    # we move away from mini and maxi to sample inside the open interval (mini, maxi)
    grid = np.linspace(mini + step / 2, maxi - step / 2, num)
    if "step" in param_config.keys():
        return round_to_discreate_grid_uniform(grid, param_config)
    return grid</div>


<div class="viewcode-block" id="loguniform_grid"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.loguniform_grid">[docs]</a>def loguniform_grid(param_config):
    """
    get a loguniform distributed grid given the specifications in the param_config
    param_config: config which needs to contain 'num', 'max', 'min'
    """
    num = int(param_config["num"])
    maxi = np.log10(float(param_config["max"]))
    mini = np.log10(float(param_config["min"]))
    step = (maxi - mini) / num
    # linspace does exclude the end of the interval and include the beginning
    grid = 10 ** np.linspace(mini + step / 2, maxi - step / 2, num)
    if "step" in param_config.keys():
        return round_to_discreate_grid_uniform(grid, param_config)
    return grid</div>


<div class="viewcode-block" id="normal_grid"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.normal_grid">[docs]</a>def normal_grid(param_config, lognormal=False):
    """
    get a normal distributed grid given the specifications in the param_config
    param_config: config which needs to contain 'num', 'mean', 'std'
    """
    if int(param_config["num"]) == 1:
        return np.array([float(param_config["mean"])])
    # Boxâ€“Muller transform to get from a uniform distribution to a normal distribution
    num = int(np.floor(int(param_config["num"]) / 2))
    step = 2 / (int(param_config["num"]) + 1)
    # for a even number of samples
    if int(param_config["num"]) % 2 == 0:
        param_grid = np.arange(step, 1, step=step)[:num]
        stnormal_grid = np.sqrt(-2 * np.log(param_grid))
        stnormal_grid = np.append(stnormal_grid, -stnormal_grid)
        stnormal_grid = stnormal_grid / np.std(stnormal_grid)
        stnormal_grid = float(param_config["std"]) * stnormal_grid + float(
            param_config["mean"]
        )
    # for a odd number of samples
    else:
        param_grid = np.arange(step, 1, step=step)[:num]
        stnormal_grid = np.sqrt(-2 * np.log(param_grid))
        stnormal_grid = np.append(stnormal_grid, -stnormal_grid)
        stnormal_grid = np.append(stnormal_grid, 0)
        stnormal_grid = stnormal_grid / np.std(stnormal_grid)
        stnormal_grid = float(param_config["std"]) * stnormal_grid + float(
            param_config["mean"]
        )

    if "step" in param_config.keys() and lognormal is False:
        return round_to_discreate_grid_normal(stnormal_grid, param_config)
    return stnormal_grid</div>


<div class="viewcode-block" id="lognormal_grid"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.lognormal_grid">[docs]</a>def lognormal_grid(param_config):
    """
    get a normal distributed grid given the specifications in the param_config
    param_config: config which needs to contain 'num', 'mean', 'std'
    """
    grid = 10 ** normal_grid(param_config, lognormal=True)
    if "step" in param_config.keys():
        return round_to_discreate_grid_normal(grid, param_config)
    return grid</div>


<div class="viewcode-block" id="add_next_param_from_list"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.add_next_param_from_list">[docs]</a>def add_next_param_from_list(param_grid: dict, grid: dict, grid_df: pd.DataFrame):
    """
    can be used in a recoursive fassion to add all combinations of the parameters in
    param_grid to grid_df
    param_grid: dictionary with all possible values for each parameter
                {'p1': [1, 2, 3], 'p2': [0, 5], ...}
    grid: a grid which will build itself in the recursion, start with grid = {}
            after one step grid = {p1: 1}
    grid_df: dataframe which will save the finished grids
    task_name: task name
    also: G_MODEL_NA name
    """
    if len(param_grid.keys()) != 0:
        # specify the parameter to be used
        param_name = list(param_grid.keys())[0]
        # for all values of this parameter perform
        for param in param_grid[param_name]:
            # add the parameter to the grid
            grid_new = dict(grid)
            grid_new.update({param_name: param})
            # remove the parameter from param_grid
            param_grid_new = dict(param_grid)
            param_grid_new.pop(param_name)
            # resume with the next parameter
            add_next_param_from_list(param_grid_new, grid_new, grid_df)
    else:
        # add sample to grid_df
        grid_df.loc[len(grid_df.index)] = [grid]</div>


<div class="viewcode-block" id="add_references_and_check_constraints"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.add_references_and_check_constraints">[docs]</a>def add_references_and_check_constraints(
    grid_df_prior, grid_df, referenced_params, config, task_name
):
    """
    in the last step all parameters which are referenced need to be add to the
    grid. All gridpoints not satisfying the constraints are removed afterwards.
    """
    for dictio in grid_df_prior["params"]:
        for key, val in dictio.items():
            exec(f"{key} = val")
        # add referenced params
        for rev_param, val in referenced_params.items():
            val = eval(val)
            dictio.update({rev_param: val})
            exec(f"{rev_param} = val")
        # check constraints
        if "hyperparameters" in config.keys():
            constraints = config["hyperparameters"].get("constraints", None)
        else:
            constraints = config.get("constraints", None)
        if constraints is not None:
            accepted = True
            for constr in constraints:
                if not eval(constr):
                    accepted = False
            if accepted:
                grid_df.loc[len(grid_df.index)] = [task_name, config["model"], dictio]
        else:
            grid_df.loc[len(grid_df.index)] = [task_name, config["model"], dictio]</div>


<div class="viewcode-block" id="sample_grid"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.sample_grid">[docs]</a>def sample_grid(param_config):
    """
    given the parameter config, this function samples all parameters which are distributed
    according the the categorical, uniform, loguniform, normal or lognormal distribution.
    """
    # sample cathegorical parameter
    if param_config["distribution"] == "categorical":
        param_grid = sampling.CategoricalHyperparameter("", param_config).allowed_values
    # sample uniform parameter
    elif param_config["distribution"] == "uniform":
        param_grid = uniform_grid(param_config)
    # sample loguniform parameter
    elif param_config["distribution"] == "loguniform":
        param_grid = loguniform_grid(param_config)
    # sample normal parameter
    elif param_config["distribution"] == "normal":
        param_grid = normal_grid(param_config)
    # sample lognormal parameter
    elif param_config["distribution"] == "lognormal":
        param_grid = lognormal_grid(param_config)
    else:
        raise RuntimeError(
            f'distribution "{param_config["distribution"]}" not '
            f"implemented use a distribution from "
            f"[categorical, uniform, loguniform, normal, lognormal]"
        )

    # ensure that the gird does have the correct datatype
    # (only check for int, othervise float is used)
    if "datatype" in param_config.keys():
        if param_config["datatype"] == "int":
            param_grid = np.array(param_grid)
            param_grid = param_grid.astype(int)
        # NOTE: converting int to float will cause error for VAE, avoid do
        # it here
        return param_grid</div>


<div class="viewcode-block" id="build_param_grid_of_shared_params"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.build_param_grid_of_shared_params">[docs]</a>def build_param_grid_of_shared_params(shared_df):
    """
    go back from the data frame format of the shared hyperparamters to a list format
    """
    if shared_df is None:
        return None
    shared_grid = {}
    for key in shared_df["params"].iloc[0].keys():
        grid_points = []
        for i in shared_df["params"].keys():
            grid_points.append(shared_df["params"][i][key])
        shared_grid[key] = np.array(grid_points)
    return shared_grid</div>


<div class="viewcode-block" id="rais_error_if_num_not_specified"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.rais_error_if_num_not_specified">[docs]</a>def rais_error_if_num_not_specified(param_name: str, param_config: dict):
    """
    for each parameter a number of grid points needs to be specified
    This function raises an error if this is not the case
    param_name: parameter name under consideration
    param_config: config of this parameter
    """
    if param_name == g_name_num_shared_param_samples_rand_search:
         raise RuntimeError(f"{g_name_num_shared_param_samples_rand_search} only for random search!")
    if not param_name == "constraints":
        if (
            not "num" in param_config.keys()
            and not "reference" in param_config.keys()
            and not param_config["distribution"] == "categorical"
        ):
            raise RuntimeError(
                f"the number of parameters in the grid direction "
                f"of {param_name} needs to be specified"
            )</div>


<div class="viewcode-block" id="add_shared_params_to_param_grids"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.add_shared_params_to_param_grids">[docs]</a>def add_shared_params_to_param_grids(shared_df, dict_param_grids, config):
    """
    use the parameters in the dataframe of shared parameters and add them
    to the dictionary of parameters for the current task
    only the shared parameters specified in the config are respected
    shared_df: Dataframe of shared hyperparameters
    dict_param_grids: dictionary of the parameter grids
    config: config for the current task
    """
    dict_shared_grid = build_param_grid_of_shared_params(shared_df)
    if "shared" in config.keys():
        list_names = config["shared"]
        dict_shared_grid = {key: dict_shared_grid[key] for key in config["shared"]}
        if dict_shared_grid is not None:
            for key in dict_shared_grid.keys():
                dict_param_grids[key] = dict_shared_grid[key]
    return dict_param_grids</div>


<div class="viewcode-block" id="grid_task"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.grid_task">[docs]</a>def grid_task(
    grid_df: pd.DataFrame, task_name: str, config: dict, shared_df: pd.DataFrame
):
    """create grid for one sampling task for a method and add it to the dataframe"""
    if "hyperparameters" in config.keys():
        dict_param_grids = {}
        referenced_params = {}
        for param_name in config["hyperparameters"].keys():
            param_config = config["hyperparameters"][param_name]
            rais_error_if_num_not_specified(param_name, param_config)

            # constraints are not parameters
            if not param_name == "constraints":
                # remember all parameters which are reverenced
                if "datatype" not in param_config.keys():
                    warnings.warn(
                        f"datatype not specified in {param_config} \
                                  for {param_name}, take float as default"
                    )
                    param_config["datatype"] = "float"

                if "reference" in param_config.keys():
                    referenced_params.update({param_name: param_config["reference"]})
                # sample other parameter
                elif param_name != "constraints":
                    dict_param_grids.update({param_name: sample_grid(param_config)})

        # create the grid from the individual parameter grids
        # constraints are not respected in this step
        grid_df_prior = pd.DataFrame(columns=["params"])
        # add shared parameters to dict_param_grids
        dict_param_grids = add_shared_params_to_param_grids(
            shared_df, dict_param_grids, config
        )
        add_next_param_from_list(dict_param_grids, {}, grid_df_prior)

        # add referenced params and check constraints
        add_references_and_check_constraints(
            grid_df_prior, grid_df, referenced_params, config, task_name
        )
        if grid_df[grid_df[G_MODEL_NA] == config["model"]].shape[0] == 0:
            raise RuntimeError(
                "No valid value found for this grid spacing, refine grid"
            )
        return grid_df
    elif "shared" in config.keys():
        shared_grid = shared_df.copy()
        shared_grid[G_MODEL_NA] = config["model"]
        shared_grid[G_METHOD_NA] = task_name
        if "constraints" in config.keys():
            config["hyperparameters"] = {"constraints": config["constraints"]}
        add_references_and_check_constraints(
            shared_grid, grid_df, {}, config, task_name
        )
        return grid_df
    else:
        # add single line if no varying hyperparameters are specified.
        grid_df.loc[len(grid_df.index)] = [task_name, config["model"], {}]
        return grid_df</div>


<div class="viewcode-block" id="sample_gridsearch"><a class="viewcode-back" href="../../../domainlab.utils.html#domainlab.utils.hyperparameter_gridsearch.sample_gridsearch">[docs]</a>def sample_gridsearch(config: dict, dest: str = None) -&gt; pd.DataFrame:
    """
    create the hyperparameters grid according to the given
    config, which should be the dictionary of the full
    benchmark config yaml.
    Result is saved to 'output_dir/hyperparameters.csv' of the
    config if not specified explicitly.

    Note: Parts of the yaml content are executed. Thus use this
    only with trusted config files.
    """
    if dest is None:
        dest = config["output_dir"] + os.sep + "hyperparameters.csv"

    logger = Logger.get_logger()
    samples = pd.DataFrame(columns=[G_METHOD_NA, G_MODEL_NA, "params"])
    shared_samples_full = pd.DataFrame(columns=[G_METHOD_NA, G_MODEL_NA, "params"])

    if "Shared params" in config.keys():
        shared_val = {"model": "all", "hyperparameters": config["Shared params"]}
        # fill up the dataframe shared samples
        shared_samples_full = grid_task(shared_samples_full, "all", shared_val, None)
    else:
        shared_samples_full = None
    for key, val in config.items():
        if sampling.is_dict_with_key(val, "model"):
            if shared_samples_full is not None:
                shared_samples = shared_samples_full.copy(deep=True)
                if "shared" in val.keys():
                    shared = val["shared"]
                else:
                    shared = []
                for line_num in range(shared_samples.shape[0]):
                    hyper_p_dict = shared_samples.iloc[line_num]["params"].copy()
                    key_list = copy.deepcopy(list(hyper_p_dict.keys()))
                    if not all(x in key_list for x in shared):
                        raise RuntimeError(
                            f"shared keys: {shared} not included in global shared keys {key_list}"
                        )
                    for key_ in key_list:
                        if key_ not in shared:
                            del hyper_p_dict[key_]
                    shared_samples.iloc[line_num]["params"] = hyper_p_dict
                # remove all duplicates
                shared_samples = shared_samples.drop_duplicates(subset="params")
            else:
                shared_samples = None

            samples = grid_task(samples, key, val, shared_samples)
            logger.info(
                f"number of gridpoints for {key} : "
                f'{samples[samples[G_MODEL_NA] == val["model"]].shape[0]}'
            )

    os.makedirs(os.path.dirname(dest), exist_ok=True)
    logger.info(f"number of total sampled gridpoints: {samples.shape[0]}")
    samples.to_csv(dest)
    # create a txt file with the commit information
    with open(
        config["output_dir"] + os.sep + "commit.txt", "w", encoding="utf8"
    ) as file:
        file.writelines("use git log |grep \n")
        file.writelines("consider remove leading b in the line below \n")
        file.write(get_git_tag())
    with open(
        config["output_dir"] + os.sep + "config.txt", "w", encoding="utf8"
    ) as file:
        json.dump(config, file)
    return samples</div>
</pre></div>

          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2021-2024, Marr Lab..
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>